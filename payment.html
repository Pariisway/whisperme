<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokens & Payment - Whisper+me</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Stripe JS -->
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <h1>Whisper<span>+me</span></h1>
            </a>
            <div class="nav-links">
                <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
                <a href="payment.html" class="active"><i class="fas fa-coins"></i> Tokens</a>
                <a href="profile.html"><i class="fas fa-user-edit"></i> Profile</a>
                <a href="#" id="logoutBtn" class="btn btn-small btn-outline"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="section">
            <div class="dashboard-header">
                <div class="welcome-message">
                    <h1><i class="fas fa-coins"></i> Buy Whisper Tokens</h1>
                    <p>Each token gives you one 5-minute private conversation. $15 per token.</p>
                </div>
                <div class="token-balance">
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-purple) 100%); color: white;">
                        <div class="stat-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Token Balance</h3>
                            <p id="tokenBalance">0 tokens</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Message -->
            <div id="paymentMessage" class="alert" style="display: none; margin: 1rem 0;"></div>

            <!-- Token Packages -->
            <div class="package-grid">
                <!-- Package 1 -->
                <div class="package-card">
                    <div class="package-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3>Single Token</h3>
                    <div class="package-tokens">1 Token</div>
                    <div class="package-price">$15</div>
                    <ul class="package-features">
                        <li><i class="fas fa-check"></i> 5-minute call</li>
                        <li><i class="fas fa-check"></i> Instant delivery</li>
                        <li><i class="fas fa-check"></i> No expiration</li>
                    </ul>
                    <button class="btn btn-primary buy-btn" data-tokens="1" data-price="15">
                        <i class="fas fa-shopping-cart"></i> Buy Now
                    </button>
                </div>

                <!-- Package 2 - Popular -->
                <div class="package-card popular">
                    <div class="popular-badge">BEST VALUE</div>
                    <div class="package-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>10 Tokens</h3>
                    <div class="package-tokens">10 Tokens</div>
                    <div class="package-price">$150</div>
                    <ul class="package-features">
                        <li><i class="fas fa-check"></i> 50 minutes total</li>
                        <li><i class="fas fa-check"></i> Best value</li>
                        <li><i class="fas fa-check"></i> Instant delivery</li>
                        <li><i class="fas fa-check"></i> No expiration</li>
                        <li><i class="fas fa-check"></i> Priority support</li>
                    </ul>
                    <button class="btn btn-accent buy-btn" data-tokens="10" data-price="150">
                        <i class="fas fa-crown"></i> Buy Now
                    </button>
                </div>

                <!-- Package 3 -->
                <div class="package-card">
                    <div class="package-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <h3>50 Tokens</h3>
                    <div class="package-tokens">50 Tokens</div>
                    <div class="package-price">$750</div>
                    <ul class="package-features">
                        <li><i class="fas fa-check"></i> 250 minutes total</li>
                        <li><i class="fas fa-check"></i> For power users</li>
                        <li><i class="fas fa-check"></i> Instant delivery</li>
                        <li><i class="fas fa-check"></i> No expiration</li>
                        <li><i class="fas fa-check"></i> VIP support</li>
                    </ul>
                    <button class="btn btn-primary buy-btn" data-tokens="50" data-price="750">
                        <i class="fas fa-rocket"></i> Buy Now
                    </button>
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="payment-methods-section">
                <h3><i class="fas fa-credit-card"></i> Secure Payment</h3>
                <div class="payment-icons">
                    <i class="fab fa-cc-visa fa-2x"></i>
                    <i class="fab fa-cc-mastercard fa-2x"></i>
                    <i class="fab fa-cc-amex fa-2x"></i>
                    <i class="fab fa-cc-discover fa-2x"></i>
                    <i class="fab fa-paypal fa-2x"></i>
                </div>
                <p class="text-muted">
                    <i class="fas fa-lock"></i> All payments are encrypted and secure
                </p>
            </div>

            <!-- Earnings Section -->
            <div class="earnings-section">
                <h3><i class="fas fa-money-bill-wave"></i> Your Earnings</h3>
                <div class="earnings-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalEarnings">$0</div>
                        <div class="stat-label">Total Earned</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pendingPayout">$0</div>
                        <div class="stat-label">Pending Payout</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="availablePayout">$0</div>
                        <div class="stat-label">Available</div>
                    </div>
                </div>
                
                <!-- Request Payout Button (shows when $20+) -->
                <div id="payoutSection" style="display: none; margin-top: 2rem;">
                    <button id="requestPayoutBtn" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i> Request Payout ($20+)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>
    
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/stripe-payment.js"></script>
    
    <script>
        // Load user data
        auth.onAuthStateChanged(async function(user) {
            if (!user) {
                window.location.href = 'auth.html?type=login';
                return;
            }
            
            // Load token balance
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
                const tokens = userDoc.data().tokens || 0;
                document.getElementById('tokenBalance').textContent = `${tokens} token${tokens !== 1 ? 's' : ''}`;
            }
            
            // Load earnings
            await loadEarningsData(user.uid);
        });
        
        async function loadEarningsData(userId) {
            try {
                // Get pending earnings
                const earningsQuery = await db.collection('earnings')
                    .where('userId', '==', userId)
                    .where('status', '==', 'pending')
                    .get();
                
                let pendingTotal = 0;
                earningsQuery.forEach(doc => {
                    pendingTotal += doc.data().amount;
                });
                
                // Get total earnings
                const allEarnings = await db.collection('earnings')
                    .where('userId', '==', userId)
                    .get();
                
                let totalEarned = 0;
                allEarnings.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'paid' || data.status === 'pending') {
                        totalEarned += data.amount;
                    }
                });
                
                // Update display
                document.getElementById('totalEarnings').textContent = `$${totalEarned.toFixed(2)}`;
                document.getElementById('pendingPayout').textContent = `$${pendingTotal.toFixed(2)}`;
                document.getElementById('availablePayout').textContent = pendingTotal >= 20 ? `$${pendingTotal.toFixed(2)}` : `$${pendingTotal.toFixed(2)}`;
                
                // Show payout button if $20+
                if (pendingTotal >= 20) {
                    document.getElementById('payoutSection').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading earnings:', error);
            }
        }
        
        // Request payout
        document.getElementById('requestPayoutBtn')?.addEventListener('click', async function() {
            try {
                // Get user's PayPal email
                const profileDoc = await db.collection('profiles').doc(auth.currentUser.uid).get();
                const paypalEmail = profileDoc.data()?.banking?.paypalEmail;
                
                if (!paypalEmail) {
                    alert('Please add your PayPal email in your profile first!');
                    window.location.href = 'profile.html';
                    return;
                }
                
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                this.disabled = true;
                
                // In a real app, you would call a function here
                // For now, show message
                alert('Payout request submitted! You will receive payment within 5-7 business days.');
                
                // Refresh data
                await loadEarningsData(auth.currentUser.uid);
                
            } catch (error) {
                console.error('Payout error:', error);
                alert('Error requesting payout');
            }
        });
    </script>
</body>
</html>
